# 13_MASTER_BLUEPRINT.md
## ðŸš€ Zepix Trading Bot v3.0 - Master Blueprint
### 1. ðŸ—ï¸ Feature Inventory (Full A-Z)
| Feature | Description | File(s) |
| :--- | :--- | :--- |
| **Logic Control** | Manages Strategy Logic (Logic1, Logic2, Logic3) selection and config. | `src/config.py`, `src/managers/autonomous_system_manager.py` |
| **Dual Order System** | Splits orders into "TP Trail" (A) and "Profit Trail" (B) for split exits. | `src/managers/dual_order_manager.py`, `src/core/trading_engine.py` |
| **SL Hunt Recovery** | Detects SL hits and re-enters if price reverses (Anti-Stop-Hunt). | `src/managers/reentry_manager.py`, `src/services/price_monitor_service.py` |
| **TP Continuation** | Re-enters trade after TP if trend continues. | `src/managers/autonomous_system_manager.py`, `src/services/price_monitor_service.py` |
| **Exit Continuation** | Re-enters after "Exit Appeared" or "Reversal" if price gaps. | `src/managers/exit_continuation_monitor.py` |
| **Profit Booking Chain** | Multi-level profit locking system (Chain reaction profit locking). | `src/managers/profit_booking_manager.py` |
| **Reverse Shield** | Hedges/Closes trades on strong reversal signals. | `src/managers/reverse_shield_manager.py` |
| **Timeframe Trends** | Adapts logic based on Higher Timeframe (HTF) trends. | `src/managers/timeframe_trend_manager.py` |
| **Risk Management** | Controls Daily Loss, Lifetime Loss, and Drawdown limits. | `src/managers/risk_manager.py` |
| **Price Watchman** | High-speed monitor for SL/TP/Entry triggers (2s interval). | `src/services/price_monitor_service.py` |
| **Menu System** | Telegram Inline Menu for full bot control. | `src/menu/` (Multiple files) |
---
### 2. ðŸ—ºï¸ System Flow Map
#### **A. Signal Ingestion**
`Webhook` -> `main.py` -> `AlertProcessor` -> `TradingEngine`
#### **B. Trade Execution**
1.  **Signal Validated**: `RiskManager` checks limits -> `TimeframeTrendManager` checks alignment.
2.  **Order Construction**: `DualOrderManager` splits order -> `PipCalculator` sets SL/TP.
3.  **Placement**: `MT5Client` places order(s) -> `TradeDatabase` records entry.
#### **C. The Watchman Cycle (2s Interval)**
`PriceMonitorService._monitor_loop()`
1.  **Stop Loss Hunt Check**: Did price hit SL? If yes -> Is price reversing back? -> **Re-Entry**.
2.  **TP Continuation Check**: Did price hit TP? If yes -> Is trend strong? -> **Re-Entry**.
3.  **Exit Continuation Check**: Did we close on signal? If yes -> Is price gaping back? -> **Re-Entry**.
4.  **Profit Chain Check**: Is profit > target? -> **Secure Profit & Move Chain**.
#### **D. Exit & Recovery**
*   **Stop Loss**: MT5 closes trade -> Watchman detects -> Trigger Recovery.
*   **Take Profit**: MT5 closes trade -> Watchman detects -> Trigger Continuation.
*   **Manual/Signal Close**: `ReversalExitHandler` closes trade -> Watchman monitors re-capture.
#### **E. Margin System**
*   **STATUS**: [DELETED] - The bot no longer closes trades based on margin levels.
---
### 3. ðŸ“‚ File Structure & Responsibilities
#### **Core (`src/core/`)**
*   `trading_engine.py`: The brain. Coordinates all managers and handles signals.
*   `database.py`: SQLite handler for Trades, Chains, and Sessions.
#### **Managers (`src/managers/`)**
*   `active_session_manager.py`: (Legacy/Merged)
*   `autonomous_system_manager.py`: High-level orchestrator for Auto-Trading features.
*   `dual_order_manager.py`: Handles Order A / Order B logic.
*   `exit_continuation_monitor.py`: Logic for re-entering after exits.
*   `profit_booking_manager.py`: Chain logic for profit locking.
*   `reentry_manager.py`: Logic for calculating re-entry levels (SL Hunt).
*   `reverse_shield_manager.py`: Protective hedging logic.
*   `risk_manager.py`: Financial safety checks (Daily/Lifetime limits).
*   `timeframe_trend_manager.py`: HTF Trend Analysis.
#### **Services (`src/services/`)**
*   `price_monitor_service.py`: **The Watchman**. Runs the async loop checking prices.
*   `reversal_exit_handler.py`: Processes "Close" signals.
#### **Utils (`src/utils/`)**
*   `pip_calculator.py`: **Critical**. Calculates SL/TP Distances correctly.
*   `profit_sl_calculator.py`: Helper for dollar-based calculations.
*   `logging_config.py`: Central logging setup.
#### **Clients (`src/clients/`)**
*   `mt5_client.py`: Interface to MetaTrader 5 Terminal.
---
**Generated by Zepix Archetype Agent - 2025**
